---
title: "Example: `ehrdata`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PheCAP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
library(PheCAP)
```

```{r}
dim(ehrdata)
```

The `ehrdata` dataset in the `PheCAP` package contains the following variables.

- ICD feature: `main_ICD`, `COD1`, `COD2`, ..., `COD10`

- NLP feature: `main_NLP`, `NLP1`, `NLP2`, ..., `NLP574`

- HU feature: `healthcare_utlization`

- Phenotype: `label`

```{r}
set.seed(1234)
```

```{r}
patient_id <- rownames(ehrdata)
```

ICD feature: `main_ICD`, `COD1`, `COD2`, ..., `COD10`

```{r}
icd_feature <- data.frame(
  PatientID = patient_id,
  main_ICD = ehrdata[, "main_ICD"],
  ehrdata[, substr(colnames(ehrdata), 1, 3) == "COD"])
```

NLP feature: `main_NLP`, `NLP1`, `NLP2`, ..., `NLP574`

```{r}
nlp_feature <- data.frame(
  PatientID = patient_id,
  main_NLP = ehrdata[, "main_NLP"],
  ehrdata[, substr(colnames(ehrdata), 1, 3) == "NLP"])
```

HU feature: `healthcare_utlization`

```{r}
hu_feature <- data.frame(
  PatientID = patient_id,
  healthcare_utlization = ehrdata[, "healthcare_utlization"])
```

Phenotype (n = `r sum(!is.na(ehrdata$label))`)

```{r}
id_label <- patient_id[!is.na(ehrdata$label)]
id_label_training <- sample(id_label, round(length(id_label)/2))
id_label_validation <- setdiff(id_label, id_label_training)
```

Training Phenotype (n = `r length(id_label_training)`)

```{r}
training_label <- data.frame(
  PatientID = id_label_training, 
  label = ehrdata[patient_id %in% id_label_training, "label"])
table(training_label$label)
```

Validation Phenotype (n = `r length(id_label_validation)`)

```{r}
validation_label <- data.frame(
  PatientID = id_label_validation, 
  label = ehrdata[patient_id %in% id_label_validation, "label"])
table(validation_label$label)
```

Define features and labels used for phenotyping.

```{r}
data <- PhecapData(
  icd_feature = icd_feature,
  nlp_feature = nlp_feature,
  hu_feature = hu_feature,
  training_label = training_label,
  validation_label = validation_label,
  patient_index = "PatientID")
```

Specify the surrogate used for surrogate-assisted feature extraction (SAFE). The typical way is to specify a main ICD code, a main NLP CUI, as well as their combination. The default lower_cutoff is 1, and the default upper_cutoff is 10. In some cases one may want to define surrogate through lab test. Feel free to change the cutoffs based on domain knowledge.

```{r}
surrogates <- list(
  PhecapSurrogate(variable_names = "main_ICD", 
                  lower_cutoff = 1, upper_cutoff = 10),
  PhecapSurrogate(variable_names = "main_NLP", 
                  lower_cutoff = 1, upper_cutoff = 10),
  PhecapSurrogate(variable_names = c("main_ICD", "main_NLP"), 
                  lower_cutoff = 1, upper_cutoff = 10))
```

Run surrogate-assisted feature extraction (SAFE) and show result.

```{r, cache=TRUE}
feature_selected <- phecap_run_feature_extraction(data, surrogates)
print(feature_selected)
```

Train phenotyping model and show the fitted model, with the AUC on the training set as well as random splits.

```{r, eval=FALSE}
model <- phecap_train_phenotyping_model(data, surrogates, feature_selected)
# Error in approxfun(x, y, method = "constant", rule = 2L) : 
#   zero non-NA points
# print(model)
```

Validate phenotyping model using validation label, and show the AUC and ROC.

```{r, eval=FALSE}
validation <- phecap_validate_phenotyping_model(data, surrogates, model)
# print(validation)
phecap_plot_roc_curves(validation)
```

Apply the model to all the patients to obtain predicted phenotype.

```{r, eval=FALSE}
phenotype <- phecap_predict_phenotype(data, surrogates, model)
```

