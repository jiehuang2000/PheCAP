---
title: "Introduction to PheCAP"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PheCAP}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
library(PheCAP)
```

Generate simulated data.

```{r}
set.seed(123)
w <- rgamma(9000, 0.3)
icd_feature <- data.frame(
  PatientID = sample.int(10000, 9000),
  ICD1 = rpois(9000, 7 * (rgamma(9000, 0.2) + w) / 0.5),
  ICD2 = rpois(9000, 6 * (rgamma(9000, 0.8) + w) / 1.1),
  ICD3 = rpois(9000, 1 * rgamma(9000, 0.5) / 0.5),
  ICD4 = rpois(9000, 2 * rgamma(9000, 0.5) / 0.5))
w <- rgamma(9500, 0.4)
nlp_feature <- data.frame(
  PatientID = sample.int(10000, 9500),
  NLP1 = rpois(9500, 8 * (rgamma(9500, 0.2) + w) / 0.6),
  NLP2 = rpois(9500, 2 * (rgamma(9500, 1.1) + w) / 1.5),
  NLP3 = rpois(9500, 5 * (rgamma(9500, 0.1) + w) / 0.5),
  NLP4 = rpois(9500, 11 * rgamma(9500, 1.9) / 1.9),
  NLP5 = rpois(9500, 3 * rgamma(9500, 0.5) / 0.5),
  NLP6 = rpois(9500, 2 * rgamma(9500, 0.5) / 0.5),
  NLP7 = rpois(9500, 1 * rgamma(9500, 0.5) / 0.5))
hu_feature <- data.frame(
  PatientID = seq_len(10000),
  NoteCount = rpois(10000, 30 * rgamma(10000, 0.1) / 0.1))
df <- merge(
  merge(icd_feature, nlp_feature, by = "PatientID", all = TRUE),
  hu_feature, by = "PatientID", all = TRUE)
df[is.na(df)] <- 0
ii <- sample.int(5000, 400)
expr <- quote(plogis(
  -5 + 1.5 * log1p(ICD1) + log1p(NLP1) +
    0.8 * log1p(NLP4) - 0.5 * log1p(NoteCount)))
summary(with(df, eval(expr)))
training_label <- data.frame(
  PatientID = head(ii, 200),
  Label = rbinom(200, 1, with(df[head(ii, 200), ], eval(expr))))
validation_label <- data.frame(
  PatientID = tail(ii, 200),
  Label = rbinom(200, 1, with(df[tail(ii, 200), ], eval(expr))))
```

Define features and labels used for phenotyping.

```{r}
data <- PhecapData(
  icd_feature = icd_feature,
  nlp_feature = nlp_feature,
  hu_feature = hu_feature,
  training_label = training_label,
  validation_label = validation_label,
  patient_index = "PatientID")
```

Specify the surrogate used for surrogate-assisted feature extraction (SAFE). The typical way is to specify a main ICD code, a main NLP CUI, as well as their combination. The default lower_cutoff is 1, and the default upper_cutoff is 10. In some cases one may want to define surrogate through lab test. Feel free to change the cutoffs based on domain knowledge.

```{r}
surrogates <- list(
  PhecapSurrogate(variable_names = "ICD1", 
                  lower_cutoff = 1, upper_cutoff = 10),
  PhecapSurrogate(variable_names = "NLP1", 
                  lower_cutoff = 1, upper_cutoff = 10),
  PhecapSurrogate(variable_names = c("ICD1", "NLP1"), 
                  lower_cutoff = 1, upper_cutoff = 10))
```

Run surrogate-assisted feature extraction (SAFE) and show result.

```{r}
feature_selected <- phecap_run_feature_extraction(data, surrogates)
print(feature_selected)
```

Train phenotyping model and show the fitted model, with the AUC on the training set as well as random splits.

```{r}
model <- phecap_train_phenotyping_model(data, surrogates, feature_selected)
# print(model)
```

Validate phenotyping model using validation label, and show the AUC and ROC.

```{r}
validation <- phecap_validate_phenotyping_model(data, surrogates, model)
# print(validation)
phecap_plot_roc_curves(validation)
```

Apply the model to all the patients to obtain predicted phenotype.

```{r}
phenotype <- phecap_predict_phenotype(data, surrogates, model)
```

